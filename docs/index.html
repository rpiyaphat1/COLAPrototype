<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IEP Smart Assistant v33 - Perfect Flow</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --admin: #7c3aed;
            --bg: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            background: var(--bg);
            color: #1e293b;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        nav {
            background: #0f172a;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-links button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.3s;
            margin-left: 10px;
        }

        .nav-links button.active {
            background: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
        }

        .container {
            flex: 1;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        .card {
            background: var(--white);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1rem;
        }

        label {
            font-weight: 600;
            font-size: 0.9rem;
            color: #475569;
            display: block;
            margin-bottom: 5px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-admin {
            background: var(--admin);
            color: white;
        }

        .btn-edit {
            background: #f59e0b;
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        th,
        td {
            padding: 14px;
            border: 1px solid #f1f5f9;
            text-align: left;
        }

        th {
            background: #f8fafc;
            color: #64748b;
            font-size: 0.9rem;
        }

        .chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--white);
            border-radius: 24px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .msg {
            margin-bottom: 15px;
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 90%;
            line-height: 1.6;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
            }
        }

        .user-msg {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .ai-msg {
            background: white;
            border: 1px solid var(--border);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .footer {
            padding: 20px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #f1f5f9;
        }

        .option-btn {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin: 4px;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>

    <nav>
        <div style="font-weight: 600; font-size: 1.2rem;">IEP Assistant <span style="color:#60a5fa">v33</span></div>
        <div class="nav-links">
            <button id="navChat" class="active" onclick="togglePage('chat')">‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó</button>
            <button id="navAdmin" onclick="togglePage('admin')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin)</button>
        </div>
    </nav>

    <div class="container">
        <div id="adminPage" class="page">
            <div class="card" style="border: 2px dashed var(--admin); background: #f5f3ff; text-align: center;">
                <h3>üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Excel/CSV)</h3>
                <input type="file" id="excelInput" accept=".xlsx, .csv" style="display:none"
                    onchange="importData(event)">
                <button class="btn btn-admin" onclick="document.getElementById('excelInput').click()">üìÅ
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
            </div>

            <div class="card">
                <h3 style="margin-top:0; color:var(--primary);" id="formTitle">üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô</h3>
                <input type="hidden" id="editIndex" value="-1">
                <div class="grid">
                    <div><label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô *</label><input type="text" id="inNick"></div>
                    <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label><input type="text" id="inFull"></div>
                    <div><label>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label><input type="text" id="inClass"></div>
                    <div>
                        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á</label>
                        <select id="inType">
                            <option value="0">0. ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="1">1. ‡πÄ‡∏´‡πá‡∏ô</option>
                            <option value="2">2. ‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô</option>
                            <option value="3">3. ‡∏™‡∏ï‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤</option>
                            <option value="4">4. ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</option>
                            <option value="5">5. ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (LD)</option>
                            <option value="6">6. ‡∏û‡∏π‡∏î/‡∏†‡∏≤‡∏©‡∏≤</option>
                            <option value="7">7. ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</option>
                            <option value="8" selected>8. ‡∏≠‡∏≠‡∏ó‡∏¥‡∏™‡∏ï‡∏¥‡∏Å</option>
                            <option value="9">9. ‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≠‡∏ô</option>
                        </select>
                    </div>
                </div>
                <textarea id="inHandle" rows="2" placeholder="‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•..."
                    style="margin-top:15px;"></textarea>
                <button class="btn btn-primary" id="saveBtn" style="width:100%; margin-top:15px;"
                    onclick="saveStudent()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            </div>

            <div class="card">
                <h3>üìë ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="count">0</span> ‡∏Ñ‡∏ô)</h3>
                <div style="overflow-x:auto;">
                    <table id="studentTable">
                        <thead>
                            <tr>
                                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</th>
                                <th>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="chatPage" class="page active">
            <div class="chat-view">
                <div class="messages" id="chatBox">
                    <div class="msg ai-msg">
                        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π! ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö <br>
                        - ‡∏û‡∏¥‡∏°‡∏û‡πå <strong>"‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏õ.1/1"</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô <br>
                        - ‡∏û‡∏¥‡∏°‡∏û‡πå <strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö
                    </div>
                </div>
                <div class="footer">
                    <input type="text" id="chatInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ '‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏õ.1/1'..."
                        onkeypress="if(event.key==='Enter') doSearch()">
                    <button class="btn btn-primary" onclick="doSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const typeNames = { "0": "‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", "1": "‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡πá‡∏ô", "2": "‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô", "3": "‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏™‡∏ï‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤", "4": "‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "5": "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (LD)", "6": "‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î/‡∏†‡∏≤‡∏©‡∏≤", "7": "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°/‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå", "8": "‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏≠‡∏ó‡∏¥‡∏™‡∏ï‡∏¥‡∏Å", "9": "‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≠‡∏ô" };
        const careInfo = { "0": "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û‡∏õ‡∏Å‡∏ï‡∏¥", "1": "‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™/‡πÄ‡∏™‡∏µ‡∏¢‡∏á", "2": "‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û", "3": "‡∏¢‡πà‡∏≠‡∏¢‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô", "4": "‡∏à‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å", "5": "‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°", "6": "‡∏£‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à", "7": "‡πÅ‡∏£‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ö‡∏ß‡∏Å", "8": "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏†‡∏≤‡∏û", "9": "‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï" };

        let db = [];

        function norm(txt) {
            if (!txt) return "";
            return txt.toString().toLowerCase().replace(/[.\s\/-]/g, '').replace(/‡∏õ/g, '').trim();
        }

        function clean(v) { return (!v || v.toString().trim() === "" || v === "undefined") ? "-" : v.toString().trim(); }

        function togglePage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-links button').forEach(el => el.classList.remove('active'));
            document.getElementById(p + 'Page').classList.add('active');
            document.getElementById('nav' + p.charAt(0).toUpperCase() + p.slice(1)).classList.add('active');
        }

        function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                json.forEach((item, idx) => {
                    let tKey = Object.keys(item).find(k => k.includes("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"));
                    let rawT = tKey ? String(item[tKey]) : "0";
                    let numMatch = rawT.match(/\d+/);
                    db.push({
                        originalIdx: item["‡∏•‡∏≥‡∏î‡∏±‡∏ö"] || idx + 1,
                        nick: clean(item["‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"]),
                        full: clean(item["‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"] || item["‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á"]),
                        class: clean(item["‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"]),
                        type: numMatch ? numMatch[0] : "0",
                        handle: clean(item["‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠"])
                    });
                });
                alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); renderTable();
            };
            reader.readAsArrayBuffer(file);
        }

        function saveStudent() {
            const idx = parseInt(document.getElementById('editIndex').value);
            const s = {
                originalIdx: idx === -1 ? db.length + 1 : db[idx].originalIdx,
                nick: clean(document.getElementById('inNick').value),
                full: clean(document.getElementById('inFull').value),
                class: clean(document.getElementById('inClass').value),
                type: document.getElementById('inType').value,
                handle: clean(document.getElementById('inHandle').value)
            };
            if (idx === -1) { db.push(s); } else { db[idx] = s; }
            resetForm(); renderTable(); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        }

        function editStudent(i) {
            const s = db[i];
            document.getElementById('inNick').value = s.nick;
            document.getElementById('inFull').value = s.full;
            document.getElementById('inClass').value = s.class;
            document.getElementById('inType').value = s.type;
            document.getElementById('inHandle').value = s.handle === "-" ? "" : s.handle;
            document.getElementById('editIndex').value = i;
            document.getElementById('formTitle').innerText = "üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + s.nick;
            document.getElementById('saveBtn').innerText = "üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            document.getElementById('adminPage').scrollTop = 0;
        }

        function resetForm() {
            document.getElementById('inNick').value = ""; document.getElementById('inFull').value = "";
            document.getElementById('inClass').value = ""; document.getElementById('inHandle').value = "";
            document.getElementById('editIndex').value = "-1";
            document.getElementById('formTitle').innerText = "üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô";
            document.getElementById('saveBtn').innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
        }

        function renderTable() {
            document.getElementById('count').innerText = db.length;
            const tb = document.querySelector("#studentTable tbody");
            tb.innerHTML = db.map((s, i) => `<tr>
            <td>${s.originalIdx}</td><td>${s.nick}</td><td>${s.full}</td><td>${s.class}</td><td>${typeNames[s.type]}</td>
            <td><button class="btn btn-edit" onclick="editStudent(${i})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn btn-delete" onclick="db.splice(${i},1);renderTable()">‡∏•‡∏ö</button></td>
        </tr>`).join('');
        }

        function doSearch() {
            const val = document.getElementById('chatInput').value.trim();
            if (!val) return;
            addMsg(val, 'user-msg');
            document.getElementById('chatInput').value = "";

            setTimeout(() => {
                const target = norm(val);

                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏õ‡πä‡∏∞‡πÜ" ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)
                let exactMatch = db.find(s => s.full === val);
                if (exactMatch) return addMsg(report(exactMatch), 'ai-msg');

                // 2. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏´‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
                if (val.includes("‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠") || val.includes("‡∏™‡∏£‡∏∏‡∏õ")) {
                    let filterClass = db.find(s => val.includes(s.class) || val.includes(norm(s.class)));
                    let listToDisplay = filterClass ? db.filter(s => norm(s.class) === norm(filterClass.class)) : db;

                    if (listToDisplay.length === 0) return addMsg("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö", 'ai-msg');

                    const groups = listToDisplay.reduce((acc, s) => {
                        (acc[s.class] = acc[s.class] || []).push(s);
                        return acc;
                    }, {});

                    let res = `üìë <strong>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô${filterClass ? '‡∏ä‡∏±‡πâ‡∏ô ' + filterClass.class : ''}:</strong><br>`;
                    Object.keys(groups).sort().forEach(cls => {
                        res += `<br>üìç <strong>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${cls}</strong><br>`;
                        groups[cls].sort((a, b) => a.originalIdx - b.originalIdx).forEach(s => {
                            res += `${s.originalIdx}. ${s.nick} - ${s.full}<br>`;
                        });
                    });
                    return addMsg(res, 'ai-msg');
                }

                // 3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏õ.1/1)
                let classMatches = db.filter(s => norm(s.class) === target || (val.includes("/") && norm(s.class).includes(target)));
                if (classMatches.length > 0 && (val.includes("/") || target.length <= 4)) {
                    let btns = classMatches.map(s => `<button class="option-btn" onclick="setSearch('${s.full}')">${s.nick} (${s.full})</button>`).join('');
                    return addMsg(`‡∏û‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á <strong>${val}</strong> (${classMatches.length} ‡∏Ñ‡∏ô):<br>${btns}`, 'ai-msg');
                }

                // 4. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠
                let nameMatches = db.filter(s => norm(s.nick).includes(target) || target.includes(norm(s.nick)) || norm(s.full).includes(target));
                if (nameMatches.length === 1) return addMsg(report(nameMatches[0]), 'ai-msg');
                if (nameMatches.length > 1) {
                    let btns = nameMatches.map(s => `<button class="option-btn" onclick="setSearch('${s.full}')">${s.nick} (${s.full}) [${s.class}]</button>`).join('');
                    return addMsg(`‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ö <strong>"${val}"</strong> ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?<br>${btns}`, 'ai-msg');
                }
                addMsg(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ô‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö`, 'ai-msg');
            }, 400);
        }

        function report(s) {
            return `üìä <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${s.nick}</strong><br>‡∏ä‡∏∑‡πà‡∏≠: ${s.full} | ‡∏ä‡∏±‡πâ‡∏ô: ${s.class}<br>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${typeNames[s.type]}<br><hr style="border:0; border-top:1px solid #eee;">‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠: ${careInfo[s.type]}<br>${s.handle !== "-" ? `üí° ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞: <span style="color:blue">${s.handle}</span>` : ""}`;
        }

        function addMsg(t, c) {
            const box = document.getElementById('chatBox');
            const d = document.createElement('div'); d.className = `msg ${c}`; d.innerHTML = t;
            box.appendChild(d); box.scrollTop = box.scrollHeight;
        }

        window.setSearch = function (v) { document.getElementById('chatInput').value = v; doSearch(); }
    </script>
</body>

</html>